- hosts:
  - all

  tasks:
    - name: "Activate master/slave replication"
      lineinfile: dest=/root/pgpool.conf
                  regexp='^master_slave_mode\\s*=.*'
                  insertbefore='^#master_slave_mode = off'
                  line='master_slave_mode = on'

    - name: "Set replication mode to streaming"
      lineinfile: dest=/root/pgpool.conf
                  regexp='^master_slave_sub_mode\\s*=.*'
                  insertbefore='^#master_slave_sub_mode = \'slony\''
                  line='master_slave_sub_mode = \'stream\''

    - name: "Set pgpool2 port"
      lineinfile: dest=/root/pgpool.conf
                  regexp='^port\\s*=\\s*\\d+.*'
                  insertbefore='^#port = 5433'
                  line='port = 5431'

    - name: "Activate load balancing"
      lineinfile: dest=/root/pgpool.conf
                  regexp='^load_balance_mode\\s*=.*'
                  insertbefore='^#load_balance_mode = off'
                  line='load_balance_mode = on'

    - name: "Disable default backend #1"
      lineinfile: dest=/root/pgpool.conf
                  regexp='^backend_hostname0\\s*=\\s*\'localhost\''
                  line='#backend_hostname0 = \'localhost\''


    - name: "Add PostreSQL Backends"
      blockinfile:
        path: /root/pgpool.conf
        insertbefore: "# - Authentication -"
        marker: "# {mark} Add backend{{ lpos }} -- {{ item }}"
        content: |
          backend_hostname{{ lpos }} = '{{ item }}'
          backend_port{{ lpos }} = 5432
          backend_weight{{ lpos }} = 1
          backend_data_directory{{ lpos }} = /var/lib/postgresql/9.6/main
          backend_flag{{ lpos }} = 'ALLOW_TO_FAILOVER'

      loop: '{{ ansible_play_batch }}'
      loop_control:
        index_var: lpos

